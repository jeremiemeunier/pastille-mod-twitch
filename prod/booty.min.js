const Discord=require("discord.js"),path=require("path"),fs=require("fs"),XMLHttpRequest=require("xmlhttprequest").XMLHttpRequest;let booty_settings=JSON.parse(fs.readFileSync("booty.json")),secret_settings=JSON.parse(fs.readFileSync("secret.json")),client=new Discord.Client;function logger(e,t=!0){let n=`[32mbootyJS[${booty_settings.version}]`;n+=1==t?` ${dateReturn()} [0m `:"[0m ",console.log(`${n}${e}`);let s=new Date,o=`${s.getDate()}-${s.getMonth()}-${s.getFullYear()}`;fs.writeFile(`logs/booty-${o}.log`,`${n}${e}\r\n`,{flag:"a"},e=>{e&&console.log(e)})}function start_stream(e,t){null==t&&(t=Date.parse(new Date)),e=Date.parse(e);let n=t-booty_settings.countdown,s=t+booty_settings.countdown;return e>n&&e<s}function discordBotLive(e){for(var t=fs.readFileSync("streamer.json"),n=JSON.parse(t),s=Object.keys(n).length,o=0;o<s;o++){isonliveid(n[o],e)}}function xhrCheck(e){return 1==booty_settings.debug&&logger(`[43m[30m DEBUG : CHECK [(STATE : ${e.readyState})(STATUS : ${e.status})] [0m `),4===e.readyState&&200===e.status}function dateReturn(e){let t="";return null==e&&(e=new Date),e.getHours()<10?t+=`0${e.getHours()}:`:t+=`${e.getHours()}:`,e.getMinutes()<10?t+=`0${e.getMinutes()}:`:t+=`${e.getMinutes()}:`,e.getSeconds()<10?t+=`0${e.getSeconds()}`:t+=`${e.getSeconds()}`,e.getMilliseconds()<10&&e.getMilliseconds()<100?t+=`.00${e.getMilliseconds()}`:e.getMilliseconds()>10&&e.getMilliseconds()<100?t+=`.0${e.getMilliseconds()}`:t+=`.${e.getMilliseconds()}`,t}function boot(){logger(`as [34m${client.user.tag}[0m`,!1),1==booty_settings.waiting?(logger(`countdown : [34m${booty_settings.countdown}ms[0m`,!1),logger("as now starting countdown",!1)):logger("is to exited to wait",!1);let e=client.guilds.cache.get(secret_settings.GUILD_ID),t=client.channels.cache.find(e=>e.name===booty_settings.channel.announce),n=client.channels.cache.find(e=>e.name===booty_settings.channel.debug),s=e.roles.cache.find(e=>"@everyone"===e.name);1==booty_settings.debug&&(logger("[43m[30m START VAR SETTINGS [0m ",!1),logger(`as set channel [34m${booty_settings.channel.announce}[0m to [34m${t.id}[0m`,!1),logger(`as set channel [34m${booty_settings.channel.debug}[0m to [34m${n.id}[0m`,!1),logger(`as set everyone to [34m${s.id}[0m`,!1),logger("[43m[30m END VAR SETTINGS [0m ",!1)),logger(`send a message in [34m${booty_settings.channel.debug}[0m`,!1),n.send("i'm in the place and i'm listening for the futur streaming"),logger(`is initialized at [34m${dateReturn(new Date)}[0m`,!1),logger(`[42m[30m booty JS  [${booty_settings.version}] INITIALIZED [0m `,!1),1==booty_settings.waiting?setInterval(function(){logger(`as waiting [34m${booty_settings.countdown}ms[0m`),logger("as starting his work"),discordBotLive({announce:t,debug:n,every:s}),logger("as ending his work"),logger("as now starting countdown")},booty_settings.countdown):discordBotLive({announce:t,debug:n,every:s})}function isonliveid(e,t){new Date;let n=new XMLHttpRequest,s=new XMLHttpRequest,o=booty_settings.api.twitch_stream+e.twitch_id,i=`https://id.twitch.tv/oauth2/token?client_id=${secret_settings.TWITCH_CLIENT_TOKEN}&client_secret=${secret_settings.TWITCH_SECRET_TOKEN}&grant_type=client_credentials&scope=viewing_activity_read`;s.onreadystatechange=function(i){if(xhrCheck(s)){1==booty_settings.debug&&logger(`AUTH : [[32mDONE[0m  (STATUS : ${s.status})(STATE : ${s.readyState})]`);let i=JSON.parse(s.responseText);n.onreadystatechange=function(){if(!0===xhrCheck(n)){1==booty_settings.debug&&logger(`DATA : [[32mDONE[0m  (STATUS : ${n.status})(STATE : ${n.readyState})]`);let s=JSON.parse(n.responseText).data[0];null!=s?(1==booty_settings.debug&&logger(`ETAT : [[32mONLINE [0m (${e.twitch_id})]`),start_stream(s.started_at)&&0==booty_settings.debug?(t.announce.send(`Hey @everyone ! <@${e.discord_id}> est actuellement en live sur https://twitch.tv/${e.twitch_name} il stream **${s.title}** sur **${s.game_name}**`),logger(`[41m Send a message [47m[30m ${e.twitch_name} [0m`)):start_stream(s.started_at)&&1==booty_settings.debug?(logger("[41m Envoie le message [0m "),t.debug.send(`Hey @everyone ! <@${e.discord_id}> est actuellement en live sur https://twitch.tv/${e.twitch_name} il stream **${s.title}** sur **${s.game_name}**`)):logger(`[41m No message [47m[30m ${e.twitch_name} [0m `)):1==booty_settings.debug&&logger(`ETAT : [[31mOFFLINE [0m (${e.twitch_name})]`)}},n.open("GET",o,!1),n.setRequestHeader("client-id",secret_settings.TWITCH_CLIENT_TOKEN),n.setRequestHeader("Authorization","Bearer "+i.access_token),n.send()}},s.open("POST",i,!1),s.send()}logger(`[42m[30m booty JS  [${booty_settings.version}] INITIALIZE [0m `,!1),1==booty_settings.debug?(logger("[43m[30m DEBUG IS ENABLED [0m ",!1),logger(`using [34m${booty_settings.channel.debug}[0m channel to send his messages`,!1)):(logger("[43m[30m DEBUG IS DISABLED [0m ",!1),logger(`using [34m${booty_settings.channel.announce}[0m channel to send his messages`,!1)),client.on("ready",()=>{boot()}),client.login(secret_settings.BOT_TOKEN);