const Discord=require("discord.js"),path=require("path"),fs=require("fs"),XMLHttpRequest=require("xmlhttprequest").XMLHttpRequest;let booty_settings=JSON.parse(fs.readFileSync("booty.json")),secret_settings=JSON.parse(fs.readFileSync("secret.json")),client=new Discord.Client;function discordBotLive(e){for(var t=fs.readFileSync("streamer.json"),n=JSON.parse(t),s=Object.keys(n).length,i=0;i<s;i++){isonliveid(n[i],e)}}function xhrCheck(e){return 4===e.readyState&&200===e.status}function boot(){let e=client.guilds.cache.get(secret_settings.GUILD_ID),t=client.channels.cache.find(e=>e.name===booty_settings.channel.announce),n=client.channels.cache.find(e=>e.name===booty_settings.channel.debug),s=e.roles.cache.find(e=>"@everyone"===e.name);n.send("i'm in the place and i'm listening for the futur streaming"),1==booty_settings.waiting?setInterval(function(){discordBotLive({announce:t,debug:n,every:s})},booty_settings.countdown):discordBotLive({announce:t,debug:n,every:s})}function isonliveid(e,t){new Date;let n=new XMLHttpRequest,s=new XMLHttpRequest,i=booty_settings.api.twitch_stream+e.twitch_id,o=`https://id.twitch.tv/oauth2/token?client_id=${secret_settings.TWITCH_CLIENT_TOKEN}&client_secret=${secret_settings.TWITCH_SECRET_TOKEN}&grant_type=client_credentials&scope=viewing_activity_read`;s.onreadystatechange=function(o){if(xhrCheck(s)){let o=JSON.parse(s.responseText);n.onreadystatechange=function(){if(!0===xhrCheck(n)){let s=JSON.parse(n.responseText).data[0];if(null!=s){let n=Date.parse(s.started_at),i=Date.parse(new Date),o=i-booty_settings.countdown,c=i+booty_settings.countdown;n>o&&n<c&&0==booty_settings.debug&&t.announce.send(`Hey @everyone ! <@${e.discord_id}> est actuellement en live sur https://twitch.tv/${e.twitch_name} il stream **${s.title}** sur **${s.game_name}**`)}}},n.open("GET",i,!1),n.setRequestHeader("client-id",secret_settings.TWITCH_CLIENT_TOKEN),n.setRequestHeader("Authorization","Bearer "+o.access_token),n.send()}},s.open("POST",o,!1),s.send()}client.on("ready",()=>{boot()}),client.login(secret_settings.BOT_TOKEN);
